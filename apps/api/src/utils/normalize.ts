const CHAR_MAP: Record<string, string> = {
    // --- 1. CRITICAL USER REQUESTS & VISUAL FIXES ---
    '×': 'x',
    '@': 'a',
    '$': 's',
    '¥': 'y',
    '¢': 'c',
    '€': 'e',
    '♭': 'b',
    '℃': 'c',
    'α': 'a',
    'β': 'b',
    '∞': '8',

    // --- 2. COMMON SEPARATORS (Map to SPACE) ---
    '"': ' ', '“': ' ', '”': ' ', '„': ' ',
    '&': ' ', '+': ' ', '-': ' ', '_': ' ', '=': ' ',
    '.': ' ', ',': ' ', ':': ' ', ';': ' ',
    '!': ' ', '?': ' ', '~': ' ', '/': ' ', '\\': ' ',
    '|': ' ', '(': ' ', ')': ' ', '[': ' ', ']': ' ', '{': ' ', '}': ' ',
    '<': ' ', '>': ' ', '«': ' ', '»': ' ',
    '・': ' ', '…': ' ', '―': ' ', '‑': ' ',
    '★': ' ', '☆': ' ', '♥': ' ', '♡': ' ', '❤': ' ',
    '♪': ' ', '♬': ' ', '♫': ' ', '♩': ' ',
    '▲': ' ', '△': ' ', '▼': ' ', '▽': ' ', '◆': ' ', '◇': ' ',
    '■': ' ', '□': ' ', '●': ' ', '○': ' ', '◎': ' ',
    '↑': ' ', '↓': ' ', '←': ' ', '→': ' ', '↖': ' ', '↗': ' ', '↘': ' ', '↙': ' ', '↔': ' ', '↕': ' ', '⇄': ' ', '⇔': ' ',
    '※': ' ', '†': ' ', '‡': ' ', '§': ' ', '¶': ' ', '©': ' ', '®': ' ', '™': ' ',
    '【': ' ', '】': ' ', '〔': ' ', '〕': ' ', '「': ' ', '」': ' ', '『': ' ', '』': ' ',

    // --- 3. REMOVALS ---
    "'": '', '’': '', '`': '', '‘': '',
    '‌': '', '‍': '',
    '̀': '', '́': '', '̈': '', '̂': '', '̌': '', '̄': '',

    // --- 4. LATIN VARIATIONS (Accents) ---
    'á': 'a', 'à': 'a', 'â': 'a', 'ä': 'a', 'ã': 'a', 'å': 'a', 'ā': 'a', 'ą': 'a', 'ă': 'a', 'ạ': 'a', 'ả': 'a', 'ấ': 'a', 'ầ': 'a', 'ẩ': 'a', 'ẫ': 'a', 'ậ': 'a', 'ắ': 'a', 'ằ': 'a', 'ẳ': 'a', 'ẵ': 'a', 'ặ': 'a',
    'é': 'e', 'è': 'e', 'ê': 'e', 'ë': 'e', 'ē': 'e', 'ę': 'e', 'ě': 'e', 'ė': 'e', 'ẹ': 'e', 'ẻ': 'e', 'ẽ': 'e', 'ế': 'e', 'ề': 'e', 'ể': 'e', 'ễ': 'e', 'ệ': 'e',
    'í': 'i', 'ì': 'i', 'î': 'i', 'ï': 'i', 'ī': 'i', 'į': 'i', 'ı': 'i', 'ị': 'i', 'ỉ': 'i', 'ĩ': 'i',
    'ó': 'o', 'ò': 'o', 'ô': 'o', 'ö': 'o', 'õ': 'o', 'ø': 'o', 'ō': 'o', 'ő': 'o', 'ọ': 'o', 'ỏ': 'o', 'ố': 'o', 'ồ': 'o', 'ổ': 'o', 'ỗ': 'o', 'ộ': 'o', 'ớ': 'o', 'ờ': 'o', 'ở': 'o', 'ỡ': 'o', 'ợ': 'o',
    'ú': 'u', 'ù': 'u', 'û': 'u', 'ü': 'u', 'ū': 'u', 'ů': 'u', 'ű': 'u', 'ų': 'u', 'ụ': 'u', 'ủ': 'u', 'ũ': 'u', 'ư': 'u', 'ứ': 'u', 'ừ': 'u', 'ử': 'u', 'ữ': 'u', 'ự': 'u',
    'ý': 'y', 'ỳ': 'y', 'ŷ': 'y', 'ÿ': 'y', 'ỵ': 'y', 'ỷ': 'y', 'ỹ': 'y',
    
    // Consonants & Digraphs
    'ç': 'c', 'ć': 'c', 'č': 'c', 'ĉ': 'c', 'ċ': 'c',
    'đ': 'd', 'ď': 'd', 'ð': 'd',
    'ĝ': 'g', 'ğ': 'g', 'ġ': 'g', 'ģ': 'g',
    'ĥ': 'h', 'ħ': 'h',
    'ĵ': 'j',
    'ķ': 'k',
    'ł': 'l', 'ĺ': 'l', 'ļ': 'l', 'ľ': 'l',
    'ñ': 'n', 'ń': 'n', 'ņ': 'n', 'ň': 'n',
    'ŕ': 'r', 'ř': 'r',
    'ś': 's', 'š': 's', 'ş': 's', 'ŝ': 's', 'ș': 's', 'ß': 'b', // hoặc 'ss' tùy bạn, nhưng 'b' giữ độ dài ngắn
    'ť': 't', 'ţ': 't', 'ț': 't',
    'v': 'v',
    'ź': 'z', 'ż': 'z', 'ž': 'z',
    'þ': 'th', 'æ': 'ae', 'œ': 'oe', 'ə': 'a',

    // --- 5. STYLIZED / LEETSPEAK / PHONETIC ---
    '∀': 'a', 'ℵ': 'a', 'ⓐ': 'a', '∧': 'a',
    '∅': 'o', 'ο': 'o', 'о': 'o', '〇': '0', 'θ': 'o',
    'μ': 'u', 'υ': 'u', 'ᴜ': 'u',
    'λ': 'l', '˥': 'l',
    'я': 'r',
    'ω': 'o',
    'φ': 'f', 'ph': 'f',
    'ψ': 'p',
    'γ': 'g',
    'δ': 'd',
    'ε': 'e', 'ǝ': 'e',
    'ζ': 'z',
    'η': 'e',
    'ι': 'i', 'ɪ': 'i',
    'κ': 'k',
    'ν': 'n',
    'ξ': 'x',
    'π': 'p',
    'ρ': 'r',
    'σ': 's', 'ς': 's', 'ϛ': 's',
    'τ': 't',
    'χ': 'c',

    // --- 6. NUMBERS (Sub/Superscript) ---
    '⁰': '0', '¹': '1', '²': '2', '³': '3', '⁴': '4', '⁵': '5', '⁶': '6', '⁷': '7', '⁸': '8', '⁹': '9',
    '₀': '0', '₁': '1', '₂': '2', '₃': '3', '₄': '4', '₅': '5', '₆': '6', '₇': '7', '₈': '8', '₉': '9',
    '½': ' ',
};
const MIN_TRIGRAM_CHARS = 2;

/**
 * Returns tuple: [isShortName, normalizedName]
 */
export function normalizeName(input: string): [boolean, string] {
    if (!input) return [true, ''];

    const str = input.toLowerCase();
    
    let res = '';
    let nonSpaceCount = 0;
    let lastIsSpace = true; 

    const len = str.length;
    for (let i = 0; i < len; i++) {
        const char = str[i];
        
        // Lookup map
        let replacement = CHAR_MAP[char];
        
        if (replacement === undefined) {
            replacement = char;
        }

        for (let j = 0; j < replacement.length; j++) {
            const rChar = replacement[j];

            if (rChar === ' ') {
                // check the prevous char is space or not
                if (!lastIsSpace) {
                    res += ' ';
                    lastIsSpace = true;
                }
            } else {
                res += rChar;
                lastIsSpace = false;
                nonSpaceCount++; // count non space char
            }
        }
    }

    // trim trailing space
    if (res.length > 0 && res.charCodeAt(res.length - 1) === 32) {
        res = res.slice(0, -1);
    }

    return [nonSpaceCount <= MIN_TRIGRAM_CHARS, res];
}

export { CHAR_MAP };