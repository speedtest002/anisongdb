---
import { PlaylistService } from '../services/playlist/playlistService.js';

interface Props {
  songId: number;
}

const { songId } = Astro.props;
const playlists = await PlaylistService.getPlaylists();
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787/api';
---

<div class="add-to-playlist" data-song-id={songId} data-api-url={API_URL}>
  <button class="add-btn" aria-label="Add to playlist">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
  </button>
  
  <div class="playlist-dropdown" hidden>
    <div class="dropdown-header">Add to Playlist</div>
    <div class="playlist-list">
      {playlists.length > 0 ? (
        playlists.map(playlist => (
          <button class="playlist-item" data-playlist-id={playlist.id}>
            <span class="playlist-name">{playlist.name}</span>
          </button>
        ))
      ) : (
        <div class="no-playlists">No playlists found</div>
      )}
    </div>
    <div class="dropdown-footer">
      <div class="create-playlist-form" hidden>
        <input type="text" class="create-input" placeholder="Playlist name..." maxlength="50" />
        <div class="form-actions">
          <button class="cancel-create-btn">Cancel</button>
          <button class="confirm-create-btn">Create</button>
        </div>
      </div>
      <button class="create-playlist-btn">Create New Playlist</button>
    </div>
  </div>
</div>

<script>
  import { PlaylistService } from '../services/playlist/playlistService.js';
  import { addToast } from '../store/toastStore.js';

  // Handlers for dropdown and addition logic
  document.querySelectorAll('.add-to-playlist').forEach(container => {
    const btn = container.querySelector('.add-btn');
    const dropdown = container.querySelector('.playlist-dropdown');
    const createBtn = container.querySelector('.create-playlist-btn');
    const createForm = container.querySelector('.create-playlist-form');
    const createInput = container.querySelector('.create-input') as HTMLInputElement;
    const confirmCreateBtn = container.querySelector('.confirm-create-btn');
    const cancelCreateBtn = container.querySelector('.cancel-create-btn');
    
    btn?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = dropdown?.hasAttribute('hidden');
      if (isHidden) {
        document.querySelectorAll('.playlist-dropdown').forEach(d => d.setAttribute('hidden', ''));
        dropdown?.removeAttribute('hidden');
        container.classList.add('is-open');
        resetForm();
      } else {
        dropdown?.setAttribute('hidden', '');
        container.classList.remove('is-open');
      }
    });

    function resetForm() {
      createForm?.setAttribute('hidden', '');
      createBtn?.removeAttribute('hidden');
      createInput.value = '';
    }

    // Close on click outside
    document.addEventListener('click', () => {
      dropdown?.setAttribute('hidden', '');
      container.classList.remove('is-open');
      resetForm();
    });

    dropdown?.addEventListener('click', (e) => e.stopPropagation());

    // Show inline create form
    createBtn?.addEventListener('click', () => {
      createBtn.setAttribute('hidden', '');
      createForm?.removeAttribute('hidden');
      createInput.focus();
    });

    // Cancel create
    cancelCreateBtn?.addEventListener('click', () => {
      resetForm();
    });

    // Confirm Create logic
    confirmCreateBtn?.addEventListener('click', async () => {
      const name = createInput.value.trim();
      if (!name) return;

      try {
        (confirmCreateBtn as HTMLElement).innerText = '...';
        const newPlaylist = await PlaylistService.createPlaylist(name);
        
        if (newPlaylist) {
          // Add to all dropdowns on page
          document.querySelectorAll('.playlist-list').forEach(list => {
            const noPlaylists = list.querySelector('.no-playlists');
            if (noPlaylists) noPlaylists.remove();

            const newBtn = document.createElement('button');
            newBtn.className = 'playlist-item';
            newBtn.dataset.playlistId = newPlaylist.id;
            newBtn.innerHTML = ` <span class="playlist-name">${newPlaylist.name}</span>`;
            
            attachPlaylistItemListener(newBtn, (list.closest('.add-to-playlist') as HTMLElement));
            list.appendChild(newBtn);
          });
          
          addToast(`Playlist "${name}" created!`);
          resetForm();
        }
      } catch (err) {
        console.error(err);
        addToast('Failed to create playlist.', 'error');
      } finally {
        (confirmCreateBtn as HTMLElement).innerText = 'Create';
      }
    });

    // Enter key to create
    createInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') confirmCreateBtn?.dispatchEvent(new Event('click'));
      if (e.key === 'Escape') resetForm();
    });

    // Initial listeners
    container.querySelectorAll('.playlist-item').forEach(item => {
      attachPlaylistItemListener(item as HTMLButtonElement, container as HTMLElement);
    });

    function attachPlaylistItemListener(item: HTMLButtonElement, containerEl: HTMLElement) {
      item.addEventListener('click', async () => {
        const songId = containerEl.dataset.songId;
        const playlistId = item.dataset.playlistId;
        const playlistName = item.querySelector('.playlist-name')?.innerHTML || item.innerText;
        
        if (songId && playlistId) {
          try {
            item.classList.add('loading');
            item.style.pointerEvents = 'none';

            const success = await PlaylistService.addSongToPlaylist(playlistId, parseInt(songId));

            if (success) {
              addToast(`Added to ${playlistName}!`);
            } else {
              throw new Error('Failed to add');
            }
          } catch (err) {
            console.error(err);
            addToast('Failed to add song to playlist.', 'error');
          } finally {
            item.classList.remove('loading');
            item.style.pointerEvents = 'auto';
            dropdown?.setAttribute('hidden', '');
            containerEl.classList.remove('is-open');
          }
        }
      });
    }
  });
</script>

<style>
  .add-to-playlist {
    position: relative;
    display: inline-block;
  }

  .add-btn {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .add-btn:hover {
    color: white;
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.1);
  }

  .playlist-dropdown {
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 8px;
    width: 200px;
    background: #282828;
    border-radius: 8px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    z-index: 100;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .dropdown-header {
    padding: 12px 16px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-text-muted);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .playlist-list {
    max-height: 200px;
    overflow-y: auto;
  }

  .playlist-item {
    width: 100%;
    padding: 10px 16px;
    text-align: left;
    background: none;
    border: none;
    color: #e5e5e5;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .playlist-item:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .no-playlists {
    padding: 16px;
    color: var(--color-text-muted);
    font-size: 0.75rem;
    font-style: italic;
  }

  .dropdown-footer {
    padding: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .create-playlist-btn {
    width: 100%;
    padding: 8px;
    background: transparent;
    border: 1px dashed rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .create-playlist-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--color-primary);
  }

  /* Inline Form Styles */
  .create-playlist-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .create-input {
    width: 100%;
    padding: 8px 12px;
    background: #404040;
    border: 1px solid transparent;
    border-radius: 4px;
    color: white;
    font-size: 0.875rem;
    outline: none;
  }

  .create-input:focus {
    border-color: var(--color-primary);
    background: #333;
  }

  .form-actions {
    display: flex;
    gap: 4px;
  }

  .form-actions button {
    flex: 1;
    padding: 6px;
    font-size: 0.7rem;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
    border: none;
  }

  .cancel-create-btn {
    background: transparent;
    color: var(--color-text-muted);
  }

  .cancel-create-btn:hover {
    color: white;
  }

  .confirm-create-btn {
    background: var(--color-primary);
    color: black;
  }

  .confirm-create-btn:hover {
    transform: scale(1.02);
  }

  .playlist-item.loading {
    opacity: 0.5;
    position: relative;
  }

  .playlist-item.loading::after {
    content: '';
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    border: 2px solid white;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to { transform: translateY(-50%) rotate(360deg); }
  }

  [hidden] {
    display: none !important;
  }
</style>
