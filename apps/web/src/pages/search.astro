---
import Layout from '../layouts/Layout.astro';
import SearchResultItem from '../components/SearchResultItem.astro';
import { searchSongs } from '../services/song/index.js';
import { PlaylistService } from '../services/playlist/playlistService.js';

const q = Astro.url.searchParams.get('q') || '';
const category = Astro.url.searchParams.get('category') || 'all';
const type = Astro.url.searchParams.get('type') || 'all';

let results = [];
let error = null;

if (q) {
  try {
    results = await searchSongs(q, category, type);
  } catch (e) {
    console.error(e);
    error = "Failed to fetch search results. Please try again later.";
  }
}

const playlists = results.length > 0 ? await PlaylistService.getPlaylists() : [];
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787/api';
const allSongIds = results.map(s => s.annSongId).filter(id => id !== undefined);
---

<Layout title={q ? `Search: ${q} - AnisongDB` : "Search - AnisongDB"}>
  <div class="search-page">
    <header class="page-header">
      {q ? (
        <>
          <h1>Results for "{q}"</h1>
          <p class="results-count">Showing {results.length} matches</p>
        </>
      ) : (
        <h1>Search</h1>
      )}

      {results.length > 0 && (
        <div class="header-actions">
           <div class="bulk-add-container" data-song-ids={JSON.stringify(allSongIds)}>
             <button id="add-all-btn" class="bulk-add-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add All to Playlist
             </button>
             
             <div id="bulk-playlist-dropdown" class="bulk-dropdown" hidden>
               <div class="dropdown-header">Select Playlist</div>
               <div class="playlist-list">
                 {playlists.length > 0 ? (
                   playlists.map(playlist => (
                     <button class="bulk-playlist-item" data-playlist-id={playlist.id}>
                       {playlist.name}
                     </button>
                   ))
                 ) : (
                   <div class="no-playlists">No playlists found</div>
                 )}
               </div>
             </div>
           </div>
        </div>
      )}
    </header>

    {error && <div class="error-message">{error}</div>}

    <div class="results-list">
      {results.length > 0 ? (
        results.map(song => (
          <SearchResultItem song={song} />
        ))
      ) : q ? (
        <div class="empty-state">
          <p>No songs found for your search.</p>
        </div>
      ) : (
        <div class="empty-state">
          <p>Start typing in the header to search for anime songs!</p>
        </div>
      )}
    </div>
  </div>
</Layout>

<script>
  import { PlaylistService } from '../services/playlist/playlistService.js';

  const addAllBtn = document.getElementById('add-all-btn');
  const dropdown = document.getElementById('bulk-playlist-dropdown');
  const container = document.querySelector('.bulk-add-container');

  addAllBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdown?.toggleAttribute('hidden');
  });

  document.addEventListener('click', () => {
    dropdown?.setAttribute('hidden', '');
  });

  dropdown?.addEventListener('click', (e) => e.stopPropagation());

  document.querySelectorAll('.bulk-playlist-item').forEach(item => {
    item.addEventListener('click', async () => {
      const playlistId = (item as HTMLElement).dataset.playlistId;
      const songIds = JSON.parse((container as HTMLElement).dataset.songIds || '[]');
      const playlistName = (item as HTMLElement).innerText;

      if (playlistId && songIds.length > 0) {
        const btnText = (item as HTMLElement).innerText;
        try {
          (item as HTMLElement).innerText = 'Adding all...';
          (item as HTMLElement).style.opacity = '0.5';
          (item as HTMLElement).style.pointerEvents = 'none';

          const success = await PlaylistService.addSongsToPlaylist(playlistId, songIds);
          
          if (success) {
            alert(`Added ${songIds.length} songs to ${playlistName}!`);
          } else {
            throw new Error('Bulk add failed');
          }
        } catch (err) {
          console.error(err);
          alert('Failed to add songs. Please try again.');
        } finally {
          (item as HTMLElement).innerText = btnText;
          (item as HTMLElement).style.opacity = '1';
          (item as HTMLElement).style.pointerEvents = 'auto';
          dropdown?.setAttribute('hidden', '');
        }
      }
    });
  });
</script>

<style>
  .search-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 2rem;
    font-weight: 800;
    color: white;
    margin-bottom: 0.5rem;
  }

  .results-count {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .results-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .empty-state, .error-message {
    text-align: center;
    padding: 4rem 2rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 1rem;
    color: var(--color-text-muted);
  }

  .error-message {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.05);
    border: 1px solid rgba(239, 68, 68, 0.1);
  }

  /* Bulk Add Styles */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }

  .bulk-add-container {
    position: relative;
  }

  .bulk-add-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: white;
    color: black;
    border: none;
    border-radius: 2rem;
    font-weight: 700;
    font-size: 0.875rem;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .bulk-add-btn:hover {
    transform: scale(1.04);
  }

  .bulk-dropdown {
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 0.5rem;
    width: 220px;
    background: #282828;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 100;
    overflow: hidden;
  }

  .dropdown-header {
    padding: 0.75rem 1rem;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-text-muted);
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .playlist-list {
    max-height: 250px;
    overflow-y: auto;
  }

  .bulk-playlist-item {
    width: 100%;
    padding: 0.75rem 1rem;
    text-align: left;
    background: none;
    border: none;
    color: #e5e5e5;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .bulk-playlist-item:hover {
    background: rgba(255,255,255,0.1);
    color: white;
  }

  .no-playlists {
    padding: 1rem;
    color: var(--color-text-muted);
    font-size: 0.75rem;
    font-style: italic;
  }

  [hidden] {
    display: none !important;
  }

  @media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
  }
</style>
